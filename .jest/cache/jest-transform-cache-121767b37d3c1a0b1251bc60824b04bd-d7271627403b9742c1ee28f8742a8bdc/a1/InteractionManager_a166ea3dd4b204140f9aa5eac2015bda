28f8b2434cf5e80c9fcd07c6aa201bd9

'use strict';

var BatchedBridge = require('BatchedBridge');
var EventEmitter = require('EventEmitter');
var Set = require('Set');
var TaskQueue = require('TaskQueue');

var infoLog = require('infoLog');
var invariant = require('fbjs/lib/invariant');

var keyMirror = require('fbjs/lib/keyMirror');

var _emitter = new EventEmitter();

var DEBUG_DELAY = 0;
var DEBUG = false;

var InteractionManager = {
  Events: keyMirror({
    interactionStart: true,
    interactionComplete: true
  }),

  runAfterInteractions: function runAfterInteractions(task) {
    var tasks = [];
    var promise = new Promise(function (resolve) {
      _scheduleUpdate();
      if (task) {
        tasks.push(task);
      }
      tasks.push({ run: resolve, name: 'resolve ' + (task && task.name || '?') });
      _taskQueue.enqueueTasks(tasks);
    });
    return {
      then: promise.then.bind(promise),
      done: function done() {
        if (promise.done) {
          return promise.done.apply(promise, arguments);
        } else {
          console.warn('Tried to call done when not supported by current Promise implementation.');
        }
      },
      cancel: function cancel() {
        _taskQueue.cancelTasks(tasks);
      }
    };
  },
  createInteractionHandle: function createInteractionHandle() {
    DEBUG && infoLog('create interaction handle');
    _scheduleUpdate();
    var handle = ++_inc;
    _addInteractionSet.add(handle);
    return handle;
  },
  clearInteractionHandle: function clearInteractionHandle(handle) {
    DEBUG && infoLog('clear interaction handle');
    invariant(!!handle, 'Must provide a handle to clear.');
    _scheduleUpdate();
    _addInteractionSet.delete(handle);
    _deleteInteractionSet.add(handle);
  },


  addListener: _emitter.addListener.bind(_emitter),

  setDeadline: function setDeadline(deadline) {
    _deadline = deadline;
  }
};

var _interactionSet = new Set();
var _addInteractionSet = new Set();
var _deleteInteractionSet = new Set();
var _taskQueue = new TaskQueue({ onMoreTasks: _scheduleUpdate });
var _nextUpdateHandle = 0;
var _inc = 0;
var _deadline = -1;

function _scheduleUpdate() {
  if (!_nextUpdateHandle) {
    if (_deadline > 0) {
      _nextUpdateHandle = setTimeout(_processUpdate, 0 + DEBUG_DELAY);
    } else {
      _nextUpdateHandle = setImmediate(_processUpdate);
    }
  }
}

function _processUpdate() {
  _nextUpdateHandle = 0;

  var interactionCount = _interactionSet.size;
  _addInteractionSet.forEach(function (handle) {
    return _interactionSet.add(handle);
  });
  _deleteInteractionSet.forEach(function (handle) {
    return _interactionSet.delete(handle);
  });
  var nextInteractionCount = _interactionSet.size;

  if (interactionCount !== 0 && nextInteractionCount === 0) {
    _emitter.emit(InteractionManager.Events.interactionComplete);
  } else if (interactionCount === 0 && nextInteractionCount !== 0) {
    _emitter.emit(InteractionManager.Events.interactionStart);
  }

  if (nextInteractionCount === 0) {
    while (_taskQueue.hasTasksToProcess()) {
      _taskQueue.processNext();
      if (_deadline > 0 && BatchedBridge.getEventLoopRunningTime() >= _deadline) {
        _scheduleUpdate();
        break;
      }
    }
  }
  _addInteractionSet.clear();
  _deleteInteractionSet.clear();
}

module.exports = InteractionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkludGVyYWN0aW9uTWFuYWdlci5qcyJdLCJuYW1lcyI6WyJCYXRjaGVkQnJpZGdlIiwicmVxdWlyZSIsIkV2ZW50RW1pdHRlciIsIlNldCIsIlRhc2tRdWV1ZSIsImluZm9Mb2ciLCJpbnZhcmlhbnQiLCJrZXlNaXJyb3IiLCJfZW1pdHRlciIsIkRFQlVHX0RFTEFZIiwiREVCVUciLCJJbnRlcmFjdGlvbk1hbmFnZXIiLCJFdmVudHMiLCJpbnRlcmFjdGlvblN0YXJ0IiwiaW50ZXJhY3Rpb25Db21wbGV0ZSIsInJ1bkFmdGVySW50ZXJhY3Rpb25zIiwidGFzayIsInRhc2tzIiwicHJvbWlzZSIsIlByb21pc2UiLCJfc2NoZWR1bGVVcGRhdGUiLCJwdXNoIiwicnVuIiwicmVzb2x2ZSIsIm5hbWUiLCJfdGFza1F1ZXVlIiwiZW5xdWV1ZVRhc2tzIiwidGhlbiIsImJpbmQiLCJkb25lIiwiY29uc29sZSIsIndhcm4iLCJjYW5jZWwiLCJjYW5jZWxUYXNrcyIsImNyZWF0ZUludGVyYWN0aW9uSGFuZGxlIiwiaGFuZGxlIiwiX2luYyIsIl9hZGRJbnRlcmFjdGlvblNldCIsImFkZCIsImNsZWFySW50ZXJhY3Rpb25IYW5kbGUiLCJkZWxldGUiLCJfZGVsZXRlSW50ZXJhY3Rpb25TZXQiLCJhZGRMaXN0ZW5lciIsInNldERlYWRsaW5lIiwiZGVhZGxpbmUiLCJfZGVhZGxpbmUiLCJfaW50ZXJhY3Rpb25TZXQiLCJvbk1vcmVUYXNrcyIsIl9uZXh0VXBkYXRlSGFuZGxlIiwic2V0VGltZW91dCIsIl9wcm9jZXNzVXBkYXRlIiwic2V0SW1tZWRpYXRlIiwiaW50ZXJhY3Rpb25Db3VudCIsInNpemUiLCJmb3JFYWNoIiwibmV4dEludGVyYWN0aW9uQ291bnQiLCJlbWl0IiwiaGFzVGFza3NUb1Byb2Nlc3MiLCJwcm9jZXNzTmV4dCIsImdldEV2ZW50TG9vcFJ1bm5pbmdUaW1lIiwiY2xlYXIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiO0FBU0E7O0FB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IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQHByb3ZpZGVzTW9kdWxlIEludGVyYWN0aW9uTWFuYWdlclxuICogQGZsb3dcbiAqL1xuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBCYXRjaGVkQnJpZGdlID0gcmVxdWlyZSgnQmF0Y2hlZEJyaWRnZScpO1xuY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnRXZlbnRFbWl0dGVyJyk7XG5jb25zdCBTZXQgPSByZXF1aXJlKCdTZXQnKTtcbmNvbnN0IFRhc2tRdWV1ZSA9IHJlcXVpcmUoJ1Rhc2tRdWV1ZScpO1xuXG5jb25zdCBpbmZvTG9nID0gcmVxdWlyZSgnaW5mb0xvZycpO1xuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnZmJqcy9saWIvaW52YXJpYW50Jyk7XG4vKiAkRmxvd0ZpeE1lKD49MC41NC4wIHNpdGU9cmVhY3RfbmF0aXZlX29zcykgVGhpcyBjb21tZW50IHN1cHByZXNzZXMgYW4gZXJyb3JcbiAqIGZvdW5kIHdoZW4gRmxvdyB2MC41NCB3YXMgZGVwbG95ZWQuIFRvIHNlZSB0aGUgZXJyb3IgZGVsZXRlIHRoaXMgY29tbWVudCBhbmRcbiAqIHJ1biBGbG93LiAqL1xuY29uc3Qga2V5TWlycm9yID0gcmVxdWlyZSgnZmJqcy9saWIva2V5TWlycm9yJyk7XG5cbnR5cGUgSGFuZGxlID0gbnVtYmVyO1xuaW1wb3J0IHR5cGUge1Rhc2t9IGZyb20gJ1Rhc2tRdWV1ZSc7XG5cbmNvbnN0IF9lbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG5jb25zdCBERUJVR19ERUxBWSA9IDA7XG5jb25zdCBERUJVRyA9IGZhbHNlO1xuXG4vKipcbiAqIEludGVyYWN0aW9uTWFuYWdlciBhbGxvd3MgbG9uZy1ydW5uaW5nIHdvcmsgdG8gYmUgc2NoZWR1bGVkIGFmdGVyIGFueVxuICogaW50ZXJhY3Rpb25zL2FuaW1hdGlvbnMgaGF2ZSBjb21wbGV0ZWQuIEluIHBhcnRpY3VsYXIsIHRoaXMgYWxsb3dzIEphdmFTY3JpcHRcbiAqIGFuaW1hdGlvbnMgdG8gcnVuIHNtb290aGx5LlxuICpcbiAqIEFwcGxpY2F0aW9ucyBjYW4gc2NoZWR1bGUgdGFza3MgdG8gcnVuIGFmdGVyIGludGVyYWN0aW9ucyB3aXRoIHRoZSBmb2xsb3dpbmc6XG4gKlxuICogYGBgXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIucnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKCkgPT4ge1xuICogICAvLyAuLi5sb25nLXJ1bm5pbmcgc3luY2hyb25vdXMgdGFzay4uLlxuICogfSk7XG4gKiBgYGBcbiAqXG4gKiBDb21wYXJlIHRoaXMgdG8gb3RoZXIgc2NoZWR1bGluZyBhbHRlcm5hdGl2ZXM6XG4gKlxuICogLSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKTogZm9yIGNvZGUgdGhhdCBhbmltYXRlcyBhIHZpZXcgb3ZlciB0aW1lLlxuICogLSBzZXRJbW1lZGlhdGUvc2V0VGltZW91dCgpOiBydW4gY29kZSBsYXRlciwgbm90ZSB0aGlzIG1heSBkZWxheSBhbmltYXRpb25zLlxuICogLSBydW5BZnRlckludGVyYWN0aW9ucygpOiBydW4gY29kZSBsYXRlciwgd2l0aG91dCBkZWxheWluZyBhY3RpdmUgYW5pbWF0aW9ucy5cbiAqXG4gKiBUaGUgdG91Y2ggaGFuZGxpbmcgc3lzdGVtIGNvbnNpZGVycyBvbmUgb3IgbW9yZSBhY3RpdmUgdG91Y2hlcyB0byBiZSBhblxuICogJ2ludGVyYWN0aW9uJyBhbmQgd2lsbCBkZWxheSBgcnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKWAgY2FsbGJhY2tzIHVudGlsIGFsbFxuICogdG91Y2hlcyBoYXZlIGVuZGVkIG9yIGJlZW4gY2FuY2VsbGVkLlxuICpcbiAqIEludGVyYWN0aW9uTWFuYWdlciBhbHNvIGFsbG93cyBhcHBsaWNhdGlvbnMgdG8gcmVnaXN0ZXIgYW5pbWF0aW9ucyBieVxuICogY3JlYXRpbmcgYW4gaW50ZXJhY3Rpb24gJ2hhbmRsZScgb24gYW5pbWF0aW9uIHN0YXJ0LCBhbmQgY2xlYXJpbmcgaXQgdXBvblxuICogY29tcGxldGlvbjpcbiAqXG4gKiBgYGBcbiAqIHZhciBoYW5kbGUgPSBJbnRlcmFjdGlvbk1hbmFnZXIuY3JlYXRlSW50ZXJhY3Rpb25IYW5kbGUoKTtcbiAqIC8vIHJ1biBhbmltYXRpb24uLi4gKGBydW5BZnRlckludGVyYWN0aW9uc2AgdGFza3MgYXJlIHF1ZXVlZClcbiAqIC8vIGxhdGVyLCBvbiBhbmltYXRpb24gY29tcGxldGlvbjpcbiAqIEludGVyYWN0aW9uTWFuYWdlci5jbGVhckludGVyYWN0aW9uSGFuZGxlKGhhbmRsZSk7XG4gKiAvLyBxdWV1ZWQgdGFza3MgcnVuIGlmIGFsbCBoYW5kbGVzIHdlcmUgY2xlYXJlZFxuICogYGBgXG4gKlxuICogYHJ1bkFmdGVySW50ZXJhY3Rpb25zYCB0YWtlcyBlaXRoZXIgYSBwbGFpbiBjYWxsYmFjayBmdW5jdGlvbiwgb3IgYVxuICogYFByb21pc2VUYXNrYCBvYmplY3Qgd2l0aCBhIGBnZW5gIG1ldGhvZCB0aGF0IHJldHVybnMgYSBgUHJvbWlzZWAuICBJZiBhXG4gKiBgUHJvbWlzZVRhc2tgIGlzIHN1cHBsaWVkLCB0aGVuIGl0IGlzIGZ1bGx5IHJlc29sdmVkIChpbmNsdWRpbmcgYXN5bmNocm9ub3VzXG4gKiBkZXBlbmRlbmNpZXMgdGhhdCBhbHNvIHNjaGVkdWxlIG1vcmUgdGFza3MgdmlhIGBydW5BZnRlckludGVyYWN0aW9uc2ApIGJlZm9yZVxuICogc3RhcnRpbmcgb24gdGhlIG5leHQgdGFzayB0aGF0IG1pZ2h0IGhhdmUgYmVlbiBxdWV1ZWQgdXAgc3luY2hyb25vdXNseVxuICogZWFybGllci5cbiAqXG4gKiBCeSBkZWZhdWx0LCBxdWV1ZWQgdGFza3MgYXJlIGV4ZWN1dGVkIHRvZ2V0aGVyIGluIGEgbG9vcCBpbiBvbmVcbiAqIGBzZXRJbW1lZGlhdGVgIGJhdGNoLiBJZiBgc2V0RGVhZGxpbmVgIGlzIGNhbGxlZCB3aXRoIGEgcG9zaXRpdmUgbnVtYmVyLCB0aGVuXG4gKiB0YXNrcyB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgdW50aWwgdGhlIGRlYWRsaW5lIChpbiB0ZXJtcyBvZiBqcyBldmVudCBsb29wIHJ1blxuICogdGltZSkgYXBwcm9hY2hlcywgYXQgd2hpY2ggcG9pbnQgZXhlY3V0aW9uIHdpbGwgeWllbGQgdmlhIHNldFRpbWVvdXQsXG4gKiBhbGxvd2luZyBldmVudHMgc3VjaCBhcyB0b3VjaGVzIHRvIHN0YXJ0IGludGVyYWN0aW9ucyBhbmQgYmxvY2sgcXVldWVkIHRhc2tzXG4gKiBmcm9tIGV4ZWN1dGluZywgbWFraW5nIGFwcHMgbW9yZSByZXNwb25zaXZlLlxuICovXG52YXIgSW50ZXJhY3Rpb25NYW5hZ2VyID0ge1xuICBFdmVudHM6IGtleU1pcnJvcih7XG4gICAgaW50ZXJhY3Rpb25TdGFydDogdHJ1ZSxcbiAgICBpbnRlcmFjdGlvbkNvbXBsZXRlOiB0cnVlLFxuICB9KSxcblxuICAvKipcbiAgICogU2NoZWR1bGUgYSBmdW5jdGlvbiB0byBydW4gYWZ0ZXIgYWxsIGludGVyYWN0aW9ucyBoYXZlIGNvbXBsZXRlZC4gUmV0dXJucyBhIGNhbmNlbGxhYmxlXG4gICAqIFwicHJvbWlzZVwiLlxuICAgKi9cbiAgcnVuQWZ0ZXJJbnRlcmFjdGlvbnModGFzazogP1Rhc2spOiB7dGhlbjogRnVuY3Rpb24sIGRvbmU6IEZ1bmN0aW9uLCBjYW5jZWw6IEZ1bmN0aW9ufSB7XG4gICAgY29uc3QgdGFza3MgPSBbXTtcbiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICBfc2NoZWR1bGVVcGRhdGUoKTtcbiAgICAgIGlmICh0YXNrKSB7XG4gICAgICAgIHRhc2tzLnB1c2godGFzayk7XG4gICAgICB9XG4gICAgICB0YXNrcy5wdXNoKHtydW46IHJlc29sdmUsIG5hbWU6ICdyZXNvbHZlICcgKyAodGFzayAmJiB0YXNrLm5hbWUgfHwgJz8nKX0pO1xuICAgICAgX3Rhc2tRdWV1ZS5lbnF1ZXVlVGFza3ModGFza3MpO1xuICAgIH0pO1xuICAgIHJldHVybiB7XG4gICAgICB0aGVuOiBwcm9taXNlLnRoZW4uYmluZChwcm9taXNlKSxcbiAgICAgIGRvbmU6ICguLi5hcmdzKSA9PiB7XG4gICAgICAgIGlmIChwcm9taXNlLmRvbmUpIHtcbiAgICAgICAgICByZXR1cm4gcHJvbWlzZS5kb25lKC4uLmFyZ3MpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUud2FybignVHJpZWQgdG8gY2FsbCBkb25lIHdoZW4gbm90IHN1cHBvcnRlZCBieSBjdXJyZW50IFByb21pc2UgaW1wbGVtZW50YXRpb24uJyk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBjYW5jZWw6IGZ1bmN0aW9uKCkge1xuICAgICAgICBfdGFza1F1ZXVlLmNhbmNlbFRhc2tzKHRhc2tzKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfSxcblxuICAvKipcbiAgICogTm90aWZ5IG1hbmFnZXIgdGhhdCBhbiBpbnRlcmFjdGlvbiBoYXMgc3RhcnRlZC5cbiAgICovXG4gIGNyZWF0ZUludGVyYWN0aW9uSGFuZGxlKCk6IEhhbmRsZSB7XG4gICAgREVCVUcgJiYgaW5mb0xvZygnY3JlYXRlIGludGVyYWN0aW9uIGhhbmRsZScpO1xuICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgIHZhciBoYW5kbGUgPSArK19pbmM7XG4gICAgX2FkZEludGVyYWN0aW9uU2V0LmFkZChoYW5kbGUpO1xuICAgIHJldHVybiBoYW5kbGU7XG4gIH0sXG5cbiAgLyoqXG4gICAqIE5vdGlmeSBtYW5hZ2VyIHRoYXQgYW4gaW50ZXJhY3Rpb24gaGFzIGNvbXBsZXRlZC5cbiAgICovXG4gIGNsZWFySW50ZXJhY3Rpb25IYW5kbGUoaGFuZGxlOiBIYW5kbGUpIHtcbiAgICBERUJVRyAmJiBpbmZvTG9nKCdjbGVhciBpbnRlcmFjdGlvbiBoYW5kbGUnKTtcbiAgICBpbnZhcmlhbnQoXG4gICAgICAhIWhhbmRsZSxcbiAgICAgICdNdXN0IHByb3ZpZGUgYSBoYW5kbGUgdG8gY2xlYXIuJ1xuICAgICk7XG4gICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgX2FkZEludGVyYWN0aW9uU2V0LmRlbGV0ZShoYW5kbGUpO1xuICAgIF9kZWxldGVJbnRlcmFjdGlvblNldC5hZGQoaGFuZGxlKTtcbiAgfSxcblxuICBhZGRMaXN0ZW5lcjogX2VtaXR0ZXIuYWRkTGlzdGVuZXIuYmluZChfZW1pdHRlciksXG5cbiAgLyoqXG4gICAqIEEgcG9zaXRpdmUgbnVtYmVyIHdpbGwgdXNlIHNldFRpbWVvdXQgdG8gc2NoZWR1bGUgYW55IHRhc2tzIGFmdGVyIHRoZVxuICAgKiBldmVudExvb3BSdW5uaW5nVGltZSBoaXRzIHRoZSBkZWFkbGluZSB2YWx1ZSwgb3RoZXJ3aXNlIGFsbCB0YXNrcyB3aWxsIGJlXG4gICAqIGV4ZWN1dGVkIGluIG9uZSBzZXRJbW1lZGlhdGUgYmF0Y2ggKGRlZmF1bHQpLlxuICAgKi9cbiAgc2V0RGVhZGxpbmUoZGVhZGxpbmU6IG51bWJlcikge1xuICAgIF9kZWFkbGluZSA9IGRlYWRsaW5lO1xuICB9LFxufTtcblxuY29uc3QgX2ludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX2FkZEludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX2RlbGV0ZUludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX3Rhc2tRdWV1ZSA9IG5ldyBUYXNrUXVldWUoe29uTW9yZVRhc2tzOiBfc2NoZWR1bGVVcGRhdGV9KTtcbmxldCBfbmV4dFVwZGF0ZUhhbmRsZSA9IDA7XG5sZXQgX2luYyA9IDA7XG5sZXQgX2RlYWRsaW5lID0gLTE7XG5cbmRlY2xhcmUgZnVuY3Rpb24gc2V0SW1tZWRpYXRlKGNhbGxiYWNrOiBhbnksIC4uLmFyZ3M6IEFycmF5PGFueT4pOiBudW1iZXI7XG5cbi8qKlxuICogU2NoZWR1bGUgYW4gYXN5bmNocm9ub3VzIHVwZGF0ZSB0byB0aGUgaW50ZXJhY3Rpb24gc3RhdGUuXG4gKi9cbmZ1bmN0aW9uIF9zY2hlZHVsZVVwZGF0ZSgpIHtcbiAgaWYgKCFfbmV4dFVwZGF0ZUhhbmRsZSkge1xuICAgIGlmIChfZGVhZGxpbmUgPiAwKSB7XG4gICAgICAvKiAkRmxvd0ZpeE1lKD49MC42My4wIHNpdGU9cmVhY3RfbmF0aXZlX2ZiKSBUaGlzIGNvbW1lbnQgc3VwcHJlc3NlcyBhblxuICAgICAgICogZXJyb3IgZm91bmQgd2hlbiBGbG93IHYwLjYzIHdhcyBkZXBsb3llZC4gVG8gc2VlIHRoZSBlcnJvciBkZWxldGUgdGhpc1xuICAgICAgICogY29tbWVudCBhbmQgcnVuIEZsb3cuICovXG4gICAgICBfbmV4dFVwZGF0ZUhhbmRsZSA9IHNldFRpbWVvdXQoX3Byb2Nlc3NVcGRhdGUsIDAgKyBERUJVR19ERUxBWSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIF9uZXh0VXBkYXRlSGFuZGxlID0gc2V0SW1tZWRpYXRlKF9wcm9jZXNzVXBkYXRlKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBOb3RpZnkgbGlzdGVuZXJzLCBwcm9jZXNzIHF1ZXVlLCBldGNcbiAqL1xuZnVuY3Rpb24gX3Byb2Nlc3NVcGRhdGUoKSB7XG4gIF9uZXh0VXBkYXRlSGFuZGxlID0gMDtcblxuICB2YXIgaW50ZXJhY3Rpb25Db3VudCA9IF9pbnRlcmFjdGlvblNldC5zaXplO1xuICBfYWRkSW50ZXJhY3Rpb25TZXQuZm9yRWFjaChoYW5kbGUgPT5cbiAgICBfaW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSlcbiAgKTtcbiAgX2RlbGV0ZUludGVyYWN0aW9uU2V0LmZvckVhY2goaGFuZGxlID0+XG4gICAgX2ludGVyYWN0aW9uU2V0LmRlbGV0ZShoYW5kbGUpXG4gICk7XG4gIHZhciBuZXh0SW50ZXJhY3Rpb25Db3VudCA9IF9pbnRlcmFjdGlvblNldC5zaXplO1xuXG4gIGlmIChpbnRlcmFjdGlvbkNvdW50ICE9PSAwICYmIG5leHRJbnRlcmFjdGlvbkNvdW50ID09PSAwKSB7XG4gICAgLy8gdHJhbnNpdGlvbiBmcm9tIDErIC0tPiAwIGludGVyYWN0aW9uc1xuICAgIF9lbWl0dGVyLmVtaXQoSW50ZXJhY3Rpb25NYW5hZ2VyLkV2ZW50cy5pbnRlcmFjdGlvbkNvbXBsZXRlKTtcbiAgfSBlbHNlIGlmIChpbnRlcmFjdGlvbkNvdW50ID09PSAwICYmIG5leHRJbnRlcmFjdGlvbkNvdW50ICE9PSAwKSB7XG4gICAgLy8gdHJhbnNpdGlvbiBmcm9tIDAgLS0+IDErIGludGVyYWN0aW9uc1xuICAgIF9lbWl0dGVyLmVtaXQoSW50ZXJhY3Rpb25NYW5hZ2VyLkV2ZW50cy5pbnRlcmFjdGlvblN0YXJ0KTtcbiAgfVxuXG4gIC8vIHByb2Nlc3MgdGhlIHF1ZXVlIHJlZ2FyZGxlc3Mgb2YgYSB0cmFuc2l0aW9uXG4gIGlmIChuZXh0SW50ZXJhY3Rpb25Db3VudCA9PT0gMCkge1xuICAgIHdoaWxlIChfdGFza1F1ZXVlLmhhc1Rhc2tzVG9Qcm9jZXNzKCkpIHtcbiAgICAgIF90YXNrUXVldWUucHJvY2Vzc05leHQoKTtcbiAgICAgIGlmIChfZGVhZGxpbmUgPiAwICYmXG4gICAgICAgICAgQmF0Y2hlZEJyaWRnZS5nZXRFdmVudExvb3BSdW5uaW5nVGltZSgpID49IF9kZWFkbGluZSkge1xuICAgICAgICAvLyBIaXQgZGVhZGxpbmUgYmVmb3JlIHByb2Nlc3NpbmcgYWxsIHRhc2tzLCBzbyBwcm9jZXNzIG1vcmUgbGF0ZXIuXG4gICAgICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgX2FkZEludGVyYWN0aW9uU2V0LmNsZWFyKCk7XG4gIF9kZWxldGVJbnRlcmFjdGlvblNldC5jbGVhcigpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEludGVyYWN0aW9uTWFuYWdlcjtcbiJdfQ==